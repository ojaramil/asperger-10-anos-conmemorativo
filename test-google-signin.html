<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Google Sign-in</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="google-config.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        .test-button:hover {
            background: #3367d6;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <h1>üß™ Test de Google Sign-in</h1>
    
    <div class="test-container">
        <h2>Configuraci√≥n</h2>
        <div id="configStatus" class="status info">Verificando configuraci√≥n...</div>
        <div id="googleStatus" class="status info">Verificando Google API...</div>
    </div>

    <div class="test-container">
        <h2>Bot√≥n de Google Sign-in</h2>
        <div id="googleSignInButton" style="
            background: white;
            color: #333;
            border: 2px solid #e0e0e0;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        ">
            <div style="width: 20px; height: 20px; background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEwIDMuMTgxODJDMTAuOTU0NSAzLjE4MTgyIDExLjg2MzYgMy40OTU0NSAxMi41OTU1IDQuMDY4MThMMTUuNDU0NSAxLjIyNzI3QzEzLjkwOTEgLTAuNDA5MDkxIDEwLjA0NTUgLTAuNDA5MDkxIDguNSAxLjIyNzI3QzcuNDU0NTUgLTAuNDA5MDkxIDQuNTkwOTEgLTAuNDA5MDkxIDMuMDQ1NDUgMS4yMjcyN0w1LjkwNDU1IDQuMDY4MThDNi42MzYzNiAzLjQ5NTQ1IDcuNTQ1NDUgMy4xODE4MiA4LjUgMy4xODE4MkMxMC45NTQ1IDMuMTgxODIgMTMgNS4yMjcyNyAxMyA3LjY4MTgyQzEzIDEwLjEzNjQgMTAuOTU0NSAxMi4xODE4IDguNSAxMi4xODE4QzcuNDU0NTUgMTIuMTgxOCA2LjU0NTQ1IDExLjg2MzYgNS44MTM2NCAxMS4yOTA5TDIuOTU0NTUgMTQuMTMxOEM0LjUwOTA5IDE1Ljc2MzYgOC4zNzI3MyAxNS43NjM2IDkuOTE4MTggMTQuMTMxOEMxMS40NjM2IDEyLjUgMTEuNDYzNiA5LjU0NTQ1IDkuOTE4MTggNy45MDkwOUw3LjA1OTA5IDUuMDY4MThDNS40MDkwOSAzLjQ5NTQ1IDIuNTQ1NDUgMy40OTU0NSAwLjk5MDkwOSA1LjA2ODE4Qy0wLjU1NDU0NSA2LjY0MDkxIC0wLjU1NDU0NSAxMC4zNjM2IDAuOTkwOTA5IDExLjkzMThMMy44NSA4LjA5MDkxQzQuNTgxODIgOC42NjM2NCA1LjQ5MDkxIDguOTc3MjcgNi40NTQ1NSA4Ljk3NzI3QzguOTA5MDkgOC45NzcyNyAxMS4wNDU1IDYuODQwOTEgMTEuMDQ1NSA0LjM4NjM2QzExLjA0NTUgMS45MzE4MiA4LjkwOTA5IC0wLjIwNDU0NSA2LjQ1NDU1IC0wLjIwNDU0NUgxMFoiIGZpbGw9IiM0Mjg1RjQiLz4KPC9zdmc+') no-repeat center; background-size: contain;"></div>
            <span>Continuar con Google</span>
        </div>
        <div id="buttonStatus" class="status info">Haz clic en el bot√≥n para probar</div>
    </div>

    <div class="test-container">
        <h2>Log de eventos</h2>
        <div id="log" class="log"></div>
        <button class="test-button" onclick="clearLog()">Limpiar Log</button>
    </div>

    <script>
        let googleUser = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#333';
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Verificar configuraci√≥n
        function checkConfig() {
            try {
                const config = getGoogleConfig();
                log('‚úÖ Configuraci√≥n cargada correctamente');
                log(`Client ID: ${config.CLIENT_ID ? 'Configurado' : 'No configurado'}`);
                log(`Or√≠genes autorizados: ${config.AUTHORIZED_ORIGINS.join(', ')}`);
                updateStatus('configStatus', '‚úÖ Configuraci√≥n OK', 'success');
                return true;
            } catch (error) {
                log(`‚ùå Error en configuraci√≥n: ${error.message}`, 'error');
                updateStatus('configStatus', '‚ùå Error en configuraci√≥n', 'error');
                return false;
            }
        }

        // Verificar Google API
        function checkGoogleAPI() {
            if (window.google && window.google.accounts) {
                log('‚úÖ Google API cargada correctamente');
                updateStatus('googleStatus', '‚úÖ Google API disponible', 'success');
                return true;
            } else {
                log('‚ùå Google API no disponible', 'error');
                updateStatus('googleStatus', '‚ùå Google API no disponible', 'error');
                return false;
            }
        }

        // Inicializar Google Sign-in
        function initializeGoogleSignIn() {
            try {
                const config = getGoogleConfig();
                
                google.accounts.id.initialize({
                    client_id: config.CLIENT_ID,
                    callback: handleCredentialResponse,
                    auto_select: false,
                    cancel_on_tap_outside: true
                });

                // Configurar bot√≥n
                const googleButton = document.getElementById('googleSignInButton');
                googleButton.addEventListener('click', handleGoogleSignIn);
                
                log('‚úÖ Google Sign-in inicializado');
                updateStatus('buttonStatus', '‚úÖ Bot√≥n listo - Haz clic para probar', 'success');
            } catch (error) {
                log(`‚ùå Error al inicializar Google Sign-in: ${error.message}`, 'error');
                updateStatus('buttonStatus', '‚ùå Error en inicializaci√≥n', 'error');
            }
        }

        // Manejar clic en bot√≥n
        function handleGoogleSignIn() {
            log('üîÑ Bot√≥n de Google clickeado');
            updateStatus('buttonStatus', 'üîÑ Iniciando autenticaci√≥n...', 'info');
            
            try {
                // Verificar configuraci√≥n antes de mostrar popup
                const config = getGoogleConfig();
                log(`Client ID: ${config.CLIENT_ID}`);
                log(`Origen actual: ${window.location.origin}`);
                log(`Or√≠genes autorizados: ${config.AUTHORIZED_ORIGINS.join(', ')}`);
                
                // Verificar si el origen actual est√° autorizado
                const currentOrigin = window.location.origin;
                const isAuthorized = config.AUTHORIZED_ORIGINS.includes(currentOrigin);
                log(`¬øOrigen autorizado? ${isAuthorized ? '‚úÖ S√≠' : '‚ùå No'}`);
                
                if (!isAuthorized) {
                    log(`‚ö†Ô∏è ADVERTENCIA: El origen actual (${currentOrigin}) no est√° en la lista de or√≠genes autorizados`, 'error');
                    log('Esto puede causar que la autenticaci√≥n falle', 'error');
                }
                
                google.accounts.id.prompt();
                log('‚úÖ Popup de Google mostrado');
            } catch (error) {
                log(`‚ùå Error al mostrar popup: ${error.message}`, 'error');
                log(`Stack trace: ${error.stack}`, 'error');
                updateStatus('buttonStatus', '‚ùå Error al mostrar popup', 'error');
            }
        }

        // Manejar respuesta de credenciales
        function handleCredentialResponse(response) {
            log('üîÑ Credenciales recibidas');
            log(`Response object: ${JSON.stringify(response, null, 2)}`);
            updateStatus('buttonStatus', 'üîÑ Procesando credenciales...', 'info');
            
            try {
                if (!response) {
                    throw new Error('No se recibi√≥ respuesta de Google');
                }
                
                if (response.error) {
                    throw new Error(`Error de Google: ${response.error} - ${response.details || 'Sin detalles'}`);
                }
                
                if (!response.credential) {
                    throw new Error('No se recibi√≥ credencial v√°lida en la respuesta');
                }

                log(`Credencial recibida: ${response.credential.substring(0, 50)}...`);
                
                // Decodificar JWT
                const payload = decodeJwtResponse(response.credential);
                log(`‚úÖ Usuario autenticado: ${payload.name} (${payload.email})`, 'success');
                log(`Payload completo: ${JSON.stringify(payload, null, 2)}`);
                
                googleUser = {
                    name: payload.name,
                    email: payload.email,
                    picture: payload.picture,
                    id: payload.sub
                };

                updateStatus('buttonStatus', '‚úÖ Autenticaci√≥n exitosa!', 'success');
                log('üéâ Test de Google Sign-in completado exitosamente', 'success');
                
            } catch (error) {
                log(`‚ùå Error al procesar credenciales: ${error.message}`, 'error');
                log(`Stack trace: ${error.stack}`, 'error');
                updateStatus('buttonStatus', '‚ùå Error en autenticaci√≥n', 'error');
            }
        }

        // Decodificar JWT
        function decodeJwtResponse(token) {
            try {
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Token JWT malformado');
                }
                
                const base64Url = parts[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const paddedBase64 = base64 + '='.repeat((4 - base64.length % 4) % 4);
                const decoded = atob(paddedBase64);
                const jsonPayload = decodeURIComponent(decoded.split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                
                return JSON.parse(jsonPayload);
            } catch (error) {
                throw new Error('Error al decodificar JWT: ' + error.message);
            }
        }

        // Inicializar cuando la p√°gina cargue
        window.addEventListener('load', function() {
            log('üöÄ Iniciando test de Google Sign-in...');
            
            // Verificar configuraci√≥n
            if (!checkConfig()) {
                return;
            }

            // Verificar Google API
            if (!checkGoogleAPI()) {
                return;
            }

            // Inicializar Google Sign-in
            initializeGoogleSignIn();
        });

        // Tambi√©n verificar cuando Google est√© disponible
        const checkGoogle = setInterval(() => {
            if (window.google && window.google.accounts) {
                clearInterval(checkGoogle);
                log('‚úÖ Google API detectada, reinicializando...');
                initializeGoogleSignIn();
            }
        }, 100);

        // Timeout despu√©s de 10 segundos
        setTimeout(() => {
            clearInterval(checkGoogle);
            if (!window.google) {
                log('‚ùå Google API no se carg√≥ en 10 segundos', 'error');
                updateStatus('googleStatus', '‚ùå Timeout - Google API no disponible', 'error');
            }
        }, 10000);
    </script>
</body>
</html>
